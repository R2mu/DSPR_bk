<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>GWS Data Science and Problem Recognition - 5&nbsp; Module 4</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./module3.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./module4.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Module 4</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">GWS Data Science and Problem Recognition</a> 
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./module1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Module 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./module2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Module 2</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./module3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Module 3</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./module4.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Module 4</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">references.html</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#recap-from-last-module" id="toc-recap-from-last-module" class="nav-link active" data-scroll-target="#recap-from-last-module"><span class="header-section-number">5.1</span> Recap from last module</a></li>
  <li><a href="#goals-for-this-week." id="toc-goals-for-this-week." class="nav-link" data-scroll-target="#goals-for-this-week."><span class="header-section-number">5.2</span> Goals for this week.</a></li>
  <li><a href="#machine-learning-approach-to-supervised-learning" id="toc-machine-learning-approach-to-supervised-learning" class="nav-link" data-scroll-target="#machine-learning-approach-to-supervised-learning"><span class="header-section-number">5.3</span> Machine learning approach to supervised learning</a>
  <ul class="collapse">
  <li><a href="#some-quick-context" id="toc-some-quick-context" class="nav-link" data-scroll-target="#some-quick-context"><span class="header-section-number">5.3.1</span> Some quick context</a></li>
  <li><a href="#what-is-an-interaction-effect" id="toc-what-is-an-interaction-effect" class="nav-link" data-scroll-target="#what-is-an-interaction-effect"><span class="header-section-number">5.3.2</span> What is an interaction effect?</a></li>
  </ul></li>
  <li><a href="#enough-talking-lets-do-some-machine-learning" id="toc-enough-talking-lets-do-some-machine-learning" class="nav-link" data-scroll-target="#enough-talking-lets-do-some-machine-learning"><span class="header-section-number">5.4</span> Enough talking lets do some machine learning</a></li>
  <li><a href="#load-data-and-packages" id="toc-load-data-and-packages" class="nav-link" data-scroll-target="#load-data-and-packages"><span class="header-section-number">5.5</span> Load data and packages</a></li>
  <li><a href="#decision-tree" id="toc-decision-tree" class="nav-link" data-scroll-target="#decision-tree"><span class="header-section-number">5.6</span> Decision tree</a></li>
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest"><span class="header-section-number">5.7</span> Random forest</a></li>
  <li><a href="#interpreting-the-rf" id="toc-interpreting-the-rf" class="nav-link" data-scroll-target="#interpreting-the-rf"><span class="header-section-number">5.8</span> Interpreting the RF?</a></li>
  <li><a href="#so-just-use-the-random-forest" id="toc-so-just-use-the-random-forest" class="nav-link" data-scroll-target="#so-just-use-the-random-forest"><span class="header-section-number">5.9</span> So just use the Random Forest?</a></li>
  <li><a href="#wrapping-up" id="toc-wrapping-up" class="nav-link" data-scroll-target="#wrapping-up"><span class="header-section-number">5.10</span> Wrapping up</a></li>
  <li><a href="#next-week" id="toc-next-week" class="nav-link" data-scroll-target="#next-week"><span class="header-section-number">5.11</span> Next Week</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Module 4</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="recap-from-last-module" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="recap-from-last-module"><span class="header-section-number">5.1</span> Recap from last module</h2>
<p>We explored our ability to predict shot success compared to what Champion provides. We primarily did this through the lens of the generalized linear model (GLM) framework. The key strength of the GLM framework is its ability to represent models in a “linear” form even when estimating the effect on a binary variable (goal, miss), a count variable (number of disposals), or a range of other types of outcome distributions that don’t follow a normal distribution.</p>
<p>As the GLM framework is still linear, we can interpret the coefficients using standard hypothesis testing procedures (e.g., p-values). Additionally, with a bit of extra effort, we can extend the GLM framework further to allow for non-linear effects (we did this using the GAM model) and also situations where we violate the independence assumption. This final point can be achieved using mixed effects models, where you effectively let the model know that some observations will be clustered within players or teams, etc.</p>
<p>In research settings, you can see how the above type of modeling procedure can be quite attractive. We can make inferences about effects within a relatively flexible framework, provided that certain assumptions about the modeling procedure are met</p>
</section>
<section id="goals-for-this-week." class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="goals-for-this-week."><span class="header-section-number">5.2</span> Goals for this week.</h2>
<p>Our current outline for the next out weeks looks like the below.</p>
<ol type="1">
<li><p>Introduction into R programming language and getting started with some descriptive statistics.</p></li>
<li><p>Understanding key terms; Exploratory analysis, Supervised vs Unsupervised problems, regression vs classification, prediction vs association.</p></li>
<li><p>A quick note on distributions - Supervised regression and classification problems using a generalized linear model framework. (Hypothesis testing)</p></li>
<li><p><strong>Machine learning approach to Supervised learning</strong></p></li>
<li><p>Methods of assessing model accuracy</p></li>
<li><p>Bias - variance trade-off, Feature selection, hyper-parameter tuning. (this may get blended in with 5)</p></li>
<li><p>Unsupervised learning strategies (cluster analysis, PCA, market basket analysis)</p></li>
<li><p>Creating a machine learning pipeline</p></li>
</ol>
</section>
<section id="machine-learning-approach-to-supervised-learning" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="machine-learning-approach-to-supervised-learning"><span class="header-section-number">5.3</span> Machine learning approach to supervised learning</h2>
<section id="some-quick-context" class="level3" data-number="5.3.1">
<h3 data-number="5.3.1" class="anchored" data-anchor-id="some-quick-context"><span class="header-section-number">5.3.1</span> Some quick context</h3>
<p>What makes a “machine learning” model?</p>
<p>Great question!! With no definitive answer. Technically, the GLM framework above could be considered a machine learning model, and indeed, many papers have referred to things such as logistic regression as machine learning.</p>
<p>From an operational perspective, I like to think of it more along the lines of models that either focus on making reliable inferences about the variables used to predict an outcome (e.g., goal or miss, score differential) or models where the focus is more on the prediction itself, with less concern about how the prediction was made. (This is a very generalized statement)</p>
<p>Put differently, some models will significantly relax their assumptions to find clever ways to better fit the data. This relaxation of assumptions makes it harder for us to know exactly what has happened under the hood. For example, in a linear model, I effectively tell the model that I assume the effect to be “linear,” which constrains the model to this rule. This makes it easier for us to interpret but not very flexible.</p>
<p>Last week, when we used the GAM model to fit the shot data, we were effectively fitting a model that allowed us to look for non-linear effects. The easiest way to learn about these potential non-linear effects was to plot them*. Now, imagine a situation where we believe there might be interactions between different variables, some of which may be linear or non-linear, and we don’t really know in advance. It would be beneficial to have models that can potentially identify these interactions for us, and some of those models are what we are going to explore today</p>
<p>*<em>Note it is still possible to do hypothesis testing on the non-linear effects with GAMS but plotting effects is really the only way to understand the non-linear effects.</em></p>
</section>
<section id="what-is-an-interaction-effect" class="level3" data-number="5.3.2">
<h3 data-number="5.3.2" class="anchored" data-anchor-id="what-is-an-interaction-effect"><span class="header-section-number">5.3.2</span> What is an interaction effect?</h3>
<div class="cell">
<div class="cell-output-display">
<p><img src="module4_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can notice here some different effects, but lets say the effects might be even more complicated.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="module4_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now imagine that whether the effect was linear, non-linear or linear dependent on other variables as well. Hopefully, you can see how quickly this can get quite complex to model with a simple linear model.</p>
<p>For example see this example below taken from <a href="https://link.springer.com/article/10.3758/s13428-024-02389-1" class="uri">https://link.springer.com/article/10.3758/s13428-024-02389-1</a></p>
<p>Where they are looking at factors that impact science ability over time. These factors include SES (Socio Economic Status), GMOTOR (Gross motor skills) and INTERN (internalization problems).</p>
<p><img src="glmertreeGrowth.png" class="img-fluid"></p>
</section>
</section>
<section id="enough-talking-lets-do-some-machine-learning" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="enough-talking-lets-do-some-machine-learning"><span class="header-section-number">5.4</span> Enough talking lets do some machine learning</h2>
<p>Today the main models we are going to explore are the <strong>Decision Tree</strong> and <strong>Random Forest Algorithm</strong>. Lets have a quick look at where these algorithms sit on the conceptual model map from the ISLR book.</p>
<p><img src="flexibilityvsinterpretability.png" class="img-fluid"></p>
<p>The <strong>decision tree</strong> is perhaps considered one of the most interpretable machine learning algorithms in that you can just traverse a tree to get explanations of expected values (more on this in a second). As always, there is no free lunch and decision trees often are extremely sensitive to initial conditions and can vary a lot with small perturbations in the data. This link visualizers what I am talking about <a href="https://mlu-explain.github.io/decision-tree/" class="uri">https://mlu-explain.github.io/decision-tree/</a>.</p>
<p>This subsequently, reduces there performance on hold out data set and makes decision trees not necessarily the best option from a predictive standpoint.</p>
<p>We will go over how to use them anyway, as there may be an occasion where the difference in performance between a more complicated model and a decision tree is trivial enough that you choose to go with a model that is more easily interpreted. Or If you are relative confident that the key variables are the same between models, you may use the decision tree as a point of illustration but know that in the back ground you are using a better performing model.</p>
</section>
<section id="load-data-and-packages" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="load-data-and-packages"><span class="header-section-number">5.5</span> Load data and packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(data.table,tidyverse,caret,mgcv,ggtext,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>               rpart,rpart.plot,pdp,party,ranger,glue,patchwork)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>urlfile<span class="ot">=</span><span class="st">"https://raw.githubusercontent.com/R2mu/GWS_DSPR/main/data/mod2data.csv"</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>data1 <span class="ot">&lt;-</span> <span class="fu">fread</span>(urlfile)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>urlfile2<span class="ot">=</span><span class="st">"https://raw.githubusercontent.com/R2mu/GWS_DSPR/main/data/shotdata.csv"</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>data2 <span class="ot">&lt;-</span> <span class="fu">fread</span>(urlfile2)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>data2 <span class="ot">&lt;-</span> data2<span class="sc">|&gt;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Rotated.xStd=</span>shots.details.locationRotated.xStd,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">Rotated.yStd=</span>shots.details.locationRotated.yStd)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>shot_small <span class="ot">&lt;-</span> data2<span class="sc">%&gt;%</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Rotated.xStd<span class="sc">&gt;</span>(<span class="sc">-</span><span class="dv">20</span>))<span class="sc">|&gt;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Shot_outcome =</span> <span class="fu">as.factor</span>(<span class="fu">ifelse</span>(shots.result.code<span class="sc">==</span><span class="st">"G"</span>,<span class="dv">1</span>,<span class="dv">0</span>)),</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">Champ_Xp_err =</span> <span class="fu">round</span>(shots.result.points<span class="sc">-</span>shots.result.pointsExpected,<span class="dv">3</span>))</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>shot_small<span class="sc">$</span>shots.player.displayName<span class="ot">&lt;-</span><span class="fu">as.factor</span>(shot_small<span class="sc">$</span>shots.player.displayName)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>shot_small<span class="sc">$</span>shots.details.type<span class="ot">&lt;-</span><span class="fu">as.factor</span>(shot_small<span class="sc">$</span>shots.details.type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will continue to focus on what we explored last week and see if these machine learning models can help do a better job than what we achieved last week. Lets quickly recap where we got to last week.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## simple logistic regression model</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(Shot_outcome<span class="sc">~</span>Rotated.xStd<span class="sc">+</span>Rotated.yStd,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> shot_small,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">family =</span> binomial)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">bam</span>(Shot_outcome<span class="sc">~</span><span class="fu">te</span>(Rotated.xStd,Rotated.yStd,<span class="at">by=</span>shots.details.type)<span class="sc">+</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">s</span>(shots.player.displayName,<span class="at">bs=</span><span class="st">"re"</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">family =</span> binomial,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">nthreads=</span><span class="dv">8</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">discrete =</span> T,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> shot_small ,<span class="at">method =</span> <span class="st">"fREML"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>shot_small <span class="ot">&lt;-</span> shot_small<span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xG_m1 =</span> <span class="fu">predict</span>(m1,<span class="at">type=</span><span class="st">"response"</span>)<span class="sc">*</span><span class="dv">6</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">xG_m2 =</span> <span class="fu">predict</span>(m2,<span class="at">type=</span><span class="st">"response"</span>)<span class="sc">*</span><span class="dv">6</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">glm_Xp_err =</span> <span class="fu">round</span>(shots.result.points<span class="sc">-</span>xG_m1,<span class="dv">3</span>),</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">gam_Xp_err =</span> <span class="fu">round</span>(shots.result.points<span class="sc">-</span>xG_m2,<span class="dv">3</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>MAE_champ   <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(shot_small<span class="sc">$</span>Champ_Xp_err)),<span class="dv">2</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>MAE_glm     <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(shot_small<span class="sc">$</span>glm_Xp_err)),<span class="dv">2</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>MAE_gam     <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(shot_small<span class="sc">$</span>gam_Xp_err)),<span class="dv">2</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(shot_small,<span class="fu">aes</span>(<span class="fu">abs</span>(Champ_Xp_err))) <span class="sc">+</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size =</span> <span class="dv">3</span>,<span class="at">fill=</span><span class="st">"#0072B2"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,<span class="at">col=</span><span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#D55E00"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>               shot_small, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(glm_Xp_err)))<span class="sc">+</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#009E73"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>               shot_small, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(gam_Xp_err)))<span class="sc">+</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">glue</span>(<span class="st">"**Model comparison**&lt;br&gt;"</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#0072B2;'&gt;Champ: {MAE_champ}&lt;/span&gt;, "</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#D55E00;'&gt;GLM: {MAE_glm}&lt;/span&gt;, and "</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#009E73;'&gt;GAM: {MAE_gam}&lt;/span&gt;"</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_markdown</span>(<span class="at">lineheight =</span> <span class="fl">1.1</span>),</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">11</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="module4_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="decision-tree" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="decision-tree"><span class="header-section-number">5.6</span> Decision tree</h2>
<p>Lets create our first decision tree.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>m3_dt <span class="ot">&lt;-</span> <span class="fu">rpart</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> Shot_outcome<span class="sc">~</span>Rotated.xStd<span class="sc">+</span>Rotated.yStd<span class="sc">+</span> shots.details.type,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data    =</span> shot_small,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">method  =</span> <span class="st">"class"</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m3_dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
rpart(formula = Shot_outcome ~ Rotated.xStd + Rotated.yStd + 
    shots.details.type, data = shot_small, method = "class")
  n= 10886 

          CP nsplit rel error    xerror        xstd
1 0.08892714      0 1.0000000 1.0000000 0.009968954
2 0.04016064      2 0.8221457 0.8328552 0.009775323
3 0.03155479      3 0.7819851 0.8024479 0.009711314
4 0.01099637      4 0.7504303 0.7588449 0.009603362
5 0.01000000      6 0.7284376 0.7481354 0.009573871

Variable importance
      Rotated.yStd       Rotated.xStd shots.details.type 
                46                 36                 18 

Node number 1: 10886 observations,    complexity param=0.08892714
  predicted class=0  expected loss=0.4803417  P(node) =1
    class counts:  5657  5229
   probabilities: 0.520 0.480 
  left son=2 (2261 obs) right son=3 (8625 obs)
  Primary splits:
      Rotated.yStd       &lt; -21.05 to the left,  improve=139.95050, (0 missing)
      Rotated.xStd       &lt; 65.05  to the left,  improve= 77.49282, (0 missing)
      shots.details.type splits as  RLLRR,      improve= 65.45643, (0 missing)

Node number 2: 2261 observations
  predicted class=0  expected loss=0.3237506  P(node) =0.207698
    class counts:  1529   732
   probabilities: 0.676 0.324 

Node number 3: 8625 observations,    complexity param=0.08892714
  predicted class=1  expected loss=0.4786087  P(node) =0.792302
    class counts:  4128  4497
   probabilities: 0.479 0.521 
  left son=6 (2575 obs) right son=7 (6050 obs)
  Primary splits:
      Rotated.yStd       &lt; 17.55  to the right, improve=124.69680, (0 missing)
      Rotated.xStd       &lt; 57.75  to the left,  improve= 97.15160, (0 missing)
      shots.details.type splits as  RLLRR,      improve= 88.77016, (0 missing)

Node number 6: 2575 observations
  predicted class=0  expected loss=0.391068  P(node) =0.2365423
    class counts:  1568  1007
   probabilities: 0.609 0.391 

Node number 7: 6050 observations,    complexity param=0.04016064
  predicted class=1  expected loss=0.4231405  P(node) =0.5557597
    class counts:  2560  3490
   probabilities: 0.423 0.577 
  left son=14 (2274 obs) right son=15 (3776 obs)
  Primary splits:
      shots.details.type splits as  RLLRR,      improve=110.3041, (0 missing)
      Rotated.xStd       &lt; 51.45  to the left,  improve=106.6849, (0 missing)
      Rotated.yStd       &lt; -11.75 to the left,  improve= 36.7377, (0 missing)
  Surrogate splits:
      Rotated.xStd &lt; 14.5   to the left,  agree=0.627, adj=0.008, (0 split)

Node number 14: 2274 observations,    complexity param=0.01099637
  predicted class=0  expected loss=0.4538259  P(node) =0.2088922
    class counts:  1242  1032
   probabilities: 0.546 0.454 
  left son=28 (721 obs) right son=29 (1553 obs)
  Primary splits:
      Rotated.xStd       &lt; 51.45  to the left,  improve=27.450270, (0 missing)
      Rotated.yStd       &lt; -12.55 to the left,  improve=16.799070, (0 missing)
      shots.details.type splits as  -RL--,      improve= 2.128917, (0 missing)
  Surrogate splits:
      Rotated.yStd &lt; 17.35  to the right, agree=0.683, adj=0.001, (0 split)

Node number 15: 3776 observations,    complexity param=0.03155479
  predicted class=1  expected loss=0.3490466  P(node) =0.3468675
    class counts:  1318  2458
   probabilities: 0.349 0.651 
  left son=30 (1349 obs) right son=31 (2427 obs)
  Primary splits:
      Rotated.xStd       &lt; 41.05  to the left,  improve=188.85380, (0 missing)
      Rotated.yStd       &lt; -11.75 to the left,  improve= 21.76219, (0 missing)
      shots.details.type splits as  L--RR,      improve= 18.69419, (0 missing)

Node number 28: 721 observations
  predicted class=0  expected loss=0.3398058  P(node) =0.06623186
    class counts:   476   245
   probabilities: 0.660 0.340 

Node number 29: 1553 observations,    complexity param=0.01099637
  predicted class=1  expected loss=0.4932389  P(node) =0.1426603
    class counts:   766   787
   probabilities: 0.493 0.507 
  left son=58 (308 obs) right son=59 (1245 obs)
  Primary splits:
      Rotated.yStd       &lt; -12.55 to the left,  improve=19.513420, (0 missing)
      shots.details.type splits as  -RL--,      improve=12.585550, (0 missing)
      Rotated.xStd       &lt; 75.55  to the right, improve= 1.830883, (0 missing)

Node number 30: 1349 observations
  predicted class=0  expected loss=0.4388436  P(node) =0.1239206
    class counts:   757   592
   probabilities: 0.561 0.439 

Node number 31: 2427 observations
  predicted class=1  expected loss=0.2311496  P(node) =0.2229469
    class counts:   561  1866
   probabilities: 0.231 0.769 

Node number 58: 308 observations
  predicted class=0  expected loss=0.3474026  P(node) =0.02829322
    class counts:   201   107
   probabilities: 0.653 0.347 

Node number 59: 1245 observations
  predicted class=1  expected loss=0.4538153  P(node) =0.1143671
    class counts:   565   680
   probabilities: 0.454 0.546 </code></pre>
</div>
</div>
<p>It is possible to read through this, but its just a lot easier to plot it instead. Here are two options.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(m3_dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="module4_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>This option make take a minute or two to run.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>pdp_result_dt<span class="ot">&lt;-</span> <span class="fu">partial</span>(m3_dt,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">pred.var =</span> <span class="fu">c</span>(<span class="st">"Rotated.xStd"</span>,<span class="st">"Rotated.yStd"</span>,<span class="st">"shots.details.type"</span>), </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> T,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">which.class =</span> <span class="dv">2</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pdp_result_dt, <span class="fu">aes</span>(<span class="at">x =</span> Rotated.xStd, <span class="at">y =</span> Rotated.yStd, <span class="at">fill =</span> yhat)) <span class="sc">+</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_contour(aes(z = yhat), color = "white") +</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"Probability of Goal"</span>) <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> shots.details.type,<span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Partial Dependence Plot by shot type"</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Probability of goal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="module4_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Hopefully the idea of how the decision tree creates Decision boundaries is clear from the photo above.</p>
<p>Lets see how it performed even though I already know it probably won;t beat our GAM model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>shot_small <span class="ot">&lt;-</span> shot_small<span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xG_m3 =</span> <span class="fu">predict</span>(m3_dt,<span class="at">type=</span><span class="st">"prob"</span>)[,<span class="dv">2</span>]<span class="sc">*</span><span class="dv">6</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">DT_Xp_err =</span> <span class="fu">round</span>(shots.result.points<span class="sc">-</span>xG_m3,<span class="dv">3</span>))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>MAE_DT      <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(shot_small<span class="sc">$</span>DT_Xp_err)),<span class="dv">2</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(shot_small,<span class="fu">aes</span>(<span class="fu">abs</span>(Champ_Xp_err))) <span class="sc">+</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size =</span> <span class="dv">3</span>,<span class="at">fill=</span><span class="st">"#0072B2"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,<span class="at">col=</span><span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#D55E00"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>               shot_small, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(glm_Xp_err)))<span class="sc">+</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#009E73"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>               shot_small, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(gam_Xp_err)))<span class="sc">+</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#CC79A7"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>               shot_small, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(DT_Xp_err)))<span class="sc">+</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">glue</span>(<span class="st">"**Model comparison**&lt;br&gt;"</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#0072B2;'&gt;Champ: {MAE_champ}&lt;/span&gt;, "</span>,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#D55E00;'&gt;GLM: {MAE_glm}&lt;/span&gt;, and "</span>,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#009E73;'&gt;GAM: {MAE_gam}&lt;/span&gt;, and "</span>,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#CC79A7;'&gt;DT: {MAE_DT}&lt;/span&gt;"</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_markdown</span>(<span class="at">lineheight =</span> <span class="fl">1.1</span>),</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">11</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="module4_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So we can see it did better than our GLM model but worse than the champ model and GAM model. Now to be fair to the decision tree model there is some additional tuning we could do to it but the above does sort of align with a general summary of DT’s. In that they are most likely never going to have best in house predictive performance despite having a high degree of interpretability.</p>
<p>As mentioned earlier decision trees are very sensitive to initial conditions and can vary a lot from small deviations in data. <a href="https://mlu-explain.github.io/decision-tree/" class="uri">https://mlu-explain.github.io/decision-tree/</a>.</p>
</section>
<section id="random-forest" class="level2" data-number="5.7">
<h2 data-number="5.7" class="anchored" data-anchor-id="random-forest"><span class="header-section-number">5.7</span> Random forest</h2>
<p>A simple solution around the above probelm is to not build one decision tree but many decision tress (100s or 1000s) and take an aggregation of all the decision trees to give a pooled estimate. This approach is called bagging, with a special case of the bagging method called the Random forest algorithm. We will explore how a random forest algorithm will work on our data as it tends to have good out of the bag performance on tabular data but know that there other methods such as bagged trees and boosting methods which can also perform well.<br>
</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>m4_rf <span class="ot">&lt;-</span> <span class="fu">ranger</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> Shot_outcome <span class="sc">~</span> Rotated.xStd <span class="sc">+</span> Rotated.yStd <span class="sc">+</span> shots.details.type,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> shot_small,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.trees =</span> <span class="dv">300</span>,  <span class="co"># Number of trees in the forest</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="cn">NULL</span>,      <span class="co"># Number of variables to possibly split at in each node</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">importance =</span> <span class="st">'permutation'</span>,  <span class="co"># Calculate variable importance</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">probability =</span> <span class="cn">TRUE</span>  <span class="co"># For classification, set to TRUE to get probabilities</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets see how it performed</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>shot_small <span class="ot">&lt;-</span> shot_small<span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xG_m4 =</span> <span class="fu">predict</span>(m4_rf,<span class="at">data=</span>shot_small,<span class="at">type =</span> <span class="st">"response"</span>)<span class="sc">$</span>predictions[,<span class="dv">2</span>]<span class="sc">*</span><span class="dv">6</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">RF_Xp_err =</span> <span class="fu">round</span>(shots.result.points<span class="sc">-</span>xG_m4,<span class="dv">3</span>))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>MAE_RF      <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(shot_small<span class="sc">$</span>RF_Xp_err)),<span class="dv">2</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">=</span><span class="fu">ggplot</span>(shot_small,<span class="fu">aes</span>(<span class="fu">abs</span>(Champ_Xp_err))) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size =</span> <span class="dv">3</span>,<span class="at">fill=</span><span class="st">"#0072B2"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,<span class="at">col=</span><span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#D55E00"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>               shot_small, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(glm_Xp_err)))<span class="sc">+</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#009E73"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>               shot_small, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(gam_Xp_err)))<span class="sc">+</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#CC79A7"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>               shot_small, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(DT_Xp_err)))<span class="sc">+</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>       <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#E69F00"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>               shot_small, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(RF_Xp_err)))<span class="sc">+</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">glue</span>(<span class="st">"**Model comparison**&lt;br&gt;"</span>,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#0072B2;'&gt;Champ: {MAE_champ}&lt;/span&gt;, "</span>,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#D55E00;'&gt;GLM: {MAE_glm}&lt;/span&gt;, "</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#009E73;'&gt;GAM: {MAE_gam}&lt;/span&gt;, "</span>,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#CC79A7;'&gt;DT: {MAE_DT}&lt;/span&gt;, "</span>,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#E69F00;'&gt;RF: {MAE_RF}&lt;/span&gt;"</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_markdown</span>(<span class="at">lineheight =</span> <span class="fl">1.1</span>),</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">11</span>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">=</span><span class="fu">ggplot</span>(shot_small,<span class="fu">aes</span>(<span class="fu">abs</span>(Champ_Xp_err))) <span class="sc">+</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#009E73"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>               shot_small, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(gam_Xp_err)))<span class="sc">+</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>       <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#E69F00"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>               shot_small, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(RF_Xp_err)))<span class="sc">+</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">glue</span>(</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#009E73;'&gt;GAM: {MAE_gam}&lt;/span&gt;, "</span>,</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"&lt;span style='color:#E69F00;'&gt;RF: {MAE_RF}&lt;/span&gt;"</span>))<span class="sc">+</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_markdown</span>(<span class="at">lineheight =</span> <span class="fl">1.1</span>),</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">11</span>)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>finres <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">models =</span> <span class="fu">c</span>(<span class="st">"champ"</span>,<span class="st">"glm"</span>,<span class="st">"gam"</span>,<span class="st">"DT"</span>,<span class="st">"RF"</span>),</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>                    <span class="at">MAE =</span> <span class="fu">c</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(shot_small<span class="sc">$</span>Champ_Xp_err)),MAE_glm,MAE_gam,</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>                             MAE_DT,MAE_RF))</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>g3<span class="ot">=</span> <span class="fu">ggplot</span>(finres,<span class="fu">aes</span>(<span class="at">x=</span>models,<span class="at">y=</span>MAE,<span class="at">col=</span>models))<span class="sc">+</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"champ"</span><span class="ot">=</span><span class="st">"#0072B2"</span>,</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"glm"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>,</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"gam"</span> <span class="ot">=</span> <span class="st">"#009E73"</span>,</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"DT"</span> <span class="ot">=</span> <span class="st">"#CC79A7"</span>,</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"RF"</span><span class="ot">=</span><span class="st">"#E69F00"</span>))<span class="sc">+</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme_minimal</span>()</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>(g1<span class="sc">|</span>g3)<span class="sc">/</span>g2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="module4_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="interpreting-the-rf" class="level2" data-number="5.8">
<h2 data-number="5.8" class="anchored" data-anchor-id="interpreting-the-rf"><span class="header-section-number">5.8</span> Interpreting the RF?</h2>
<p>In this situation it seems to be just beating our GAM model as mentioned earlier one of the strengths of RF is that they have very good out of the box performance and whilst there are parameters that can be tuned usually fine tuning those parameters only result in trivial increases.</p>
<p>For a detailed understanding of those parameters have a read of the chapter in the <strong>ISLR book</strong> <a href="https://www.statlearning.com/" class="uri">https://www.statlearning.com/</a> or this chapter from book the <strong>Hands on Machine learning with R</strong> <a href="https://bradleyboehmke.github.io/HOML/random-forest.html" class="uri">https://bradleyboehmke.github.io/HOML/random-forest.html</a>.</p>
<p>As always there is no free lunch and a model that was perceived as easily interpretable in the decision tree now requires a different slightly more complex method for assessing which features are influencing the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(m4_rf<span class="sc">$</span>variable.importance)<span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">"variables"</span>)<span class="sc">|&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">"importance"</span><span class="ot">=</span>m4_rf.variable.importance)<span class="sc">|&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>importance,<span class="at">y=</span>variables))<span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>()<span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="module4_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now, what exactly the word “importance” means for a Random Forest can be a tad complicated. There are two common ways it can be represented: <strong>impurity</strong> and <strong>permutation</strong>. In general, the key variables will often be the same between the two approaches (impurity and permutation).</p>
<p>I’ve gone with the permutation-based method here because it has some nice characteristics:</p>
<ol type="1">
<li><p>It’s often more reliable, especially for complex datasets.</p></li>
<li><p>It’s less impacted by high cardinality features or correlations between variables.</p></li>
<li><p>It’s calculated after the model is trained, looking at how predictions change.</p></li>
</ol>
<p>In contrast, the impurity method measures importance during training based on how features split the trees.</p>
<p>So to simply describe the plot above:</p>
<ul>
<li><p>Bigger numbers mean more importance.</p></li>
<li><p>This importance is calculated by seeing how much the model accuracy decreases when data in a variable is randomly shuffled. If randomly shuffling the data in a column decreases the model accuracy a lot, this suggests the variable has high importance.</p></li>
</ul>
<p>Remember, these importance measures help us understand which features the model relies on most, but they can be misleading in that they don;t necessarily tell you the practical relevance of the effect observed. For that we need partial dependency plots.</p>
<p><strong><em>If you decide to run this just note this can take some time to run. e.g.&nbsp;on my decently powered comp this can take 10 minutes.</em></strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> shot_small[<span class="fu">sample</span>(<span class="fu">nrow</span>(shot_small), <span class="dv">400</span>), ]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>pdp_result<span class="ot">&lt;-</span> <span class="fu">partial</span>(m4_rf,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">pred.var =</span> <span class="fu">c</span>(<span class="st">"Rotated.xStd"</span>,<span class="st">"Rotated.yStd"</span>,<span class="st">"shots.details.type"</span>), </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> T,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">which.class =</span> <span class="dv">2</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">train =</span> sample_data)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pdp_result, <span class="fu">aes</span>(<span class="at">x =</span> Rotated.xStd, <span class="at">y =</span> Rotated.yStd, <span class="at">fill =</span> yhat)) <span class="sc">+</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_contour(aes(z = yhat), color = "white") +</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"Probability of Goal"</span>) <span class="sc">+</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> shots.details.type,<span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Partial Dependence Plot by shot type"</span>,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Probability of goal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="module4_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">setDT</span>(pdp_result)[shots.details.type<span class="sc">==</span><span class="st">"Set Shot Regular"</span>,],</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> Rotated.xStd, <span class="at">y =</span> Rotated.yStd, <span class="at">fill =</span> yhat)) <span class="sc">+</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_contour(aes(z = yhat), color = "white") +</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"Probability of Goal"</span>) <span class="sc">+</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> shots.details.type,<span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Partial Dependence Plot by shot type"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Probability of goal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="module4_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Lets compare that to the GAM model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vis.gam</span>(m2, <span class="at">view =</span> <span class="fu">c</span>(<span class="st">"Rotated.xStd"</span>, <span class="st">"Rotated.yStd"</span>),</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">cond=</span><span class="fu">list</span>(<span class="at">shots.details.type=</span><span class="st">"Set Shot Regular"</span>),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.type =</span> <span class="st">"contour"</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"heat"</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">too.far =</span> <span class="fl">0.1</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">#labcex = 0.8,</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">contour.col  =</span> <span class="st">"black"</span>,<span class="at">nCol =</span> <span class="dv">20</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"response"</span>,<span class="at">main =</span><span class="st">"Set Shot Regular"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="module4_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Pretty similar but you may be able to see that the GAM model is smoother while the RF is more segmented. This represents the decision boundaries that happen when creating a decision tree.</p>
</section>
<section id="so-just-use-the-random-forest" class="level2" data-number="5.9">
<h2 data-number="5.9" class="anchored" data-anchor-id="so-just-use-the-random-forest"><span class="header-section-number">5.9</span> So just use the Random Forest?</h2>
<p>Well the Random forest is a very good algorithm but we initially used it on a very big data set and whilst it has lots of procedures in place to limit <strong>over-fitting</strong> it definitely is not immune to it. Over-fitting refers to when machine learning models start to try and effectively model/capture noise in data. This can cause problems when trying to make future predictions that won;t necessarily follow those same rules learnt.</p>
<p>Lets see if our RF is struggling with that?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="do">## lets make our dataset smaller with only 3000 observations</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>shot_smaller <span class="ot">&lt;-</span> shot_small[<span class="fu">sample</span>(<span class="fu">nrow</span>(shot_small), <span class="dv">3000</span>), ]</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="do">### we are going to randomly select 75% for training and leave 25% for testing</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>train_test_split.Z  <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(shot_smaller,  <span class="at">prop =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>) </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="do">### here is our 75% split for training</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>TRAIN.z <span class="ot">&lt;-</span> <span class="fu">training</span>(train_test_split.Z</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                    )[,<span class="fu">c</span>(<span class="st">"shots.player.displayName"</span>,<span class="st">"shots.details.type"</span>)<span class="sc">:</span><span class="er">=</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">lapply</span>(.SD,as.factor),</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>                      .SDcols<span class="ot">=</span><span class="fu">c</span>(<span class="st">"shots.player.displayName"</span>,<span class="st">"shots.details.type"</span>)]</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="do">## helper function for later</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>trainNames <span class="ot">=</span> <span class="fu">unique</span>(TRAIN.z<span class="sc">$</span>shots.player.displayName)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="do">## here is our 25% spliit of data for testing</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>TEST.z  <span class="ot">&lt;-</span> <span class="fu">testing</span>(train_test_split.Z</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>                   )[,<span class="fu">c</span>(<span class="st">"shots.player.displayName"</span>,<span class="st">"shots.details.type"</span>)<span class="sc">:</span><span class="er">=</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">lapply</span>(.SD,as.factor),</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>                      .SDcols<span class="ot">=</span><span class="fu">c</span>(<span class="st">"shots.player.displayName"</span>,<span class="st">"shots.details.type"</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>                     ][,key<span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(shots.player.displayName<span class="sc">%in%</span>trainNames,<span class="dv">1</span>,<span class="dv">0</span>)]</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>TEST.z <span class="ot">=</span> TEST.z[key<span class="sc">==</span><span class="dv">1</span>,]</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>m2_gam_TRAIN <span class="ot">&lt;-</span> <span class="fu">bam</span>(</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>           Shot_outcome<span class="sc">~</span><span class="fu">te</span>(Rotated.xStd,Rotated.yStd,<span class="at">by=</span>shots.details.type)<span class="sc">+</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">s</span>(shots.player.displayName,<span class="at">bs=</span><span class="st">"re"</span>),</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>           <span class="at">family =</span> binomial,</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>           <span class="at">nthreads=</span><span class="dv">8</span>,</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>           <span class="at">discrete =</span> T,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> TRAIN.z ,</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>           <span class="at">method =</span> <span class="st">"fREML"</span>)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>m4_rf_TRAIN <span class="ot">&lt;-</span> <span class="fu">ranger</span>(</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> Shot_outcome <span class="sc">~</span> Rotated.xStd <span class="sc">+</span> Rotated.yStd <span class="sc">+</span> shots.details.type,</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> TRAIN.z,</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.trees =</span> <span class="dv">500</span>,  <span class="co"># Number of trees in the forest</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="cn">NULL</span>,      <span class="co"># Number of variables to possibly split at in each node</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">importance =</span> <span class="st">'permutation'</span>,  <span class="co"># Calculate variable importance</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">probability =</span> <span class="cn">TRUE</span>  <span class="co"># For classification, set to TRUE to get probabilities</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>TEST.z <span class="ot">=</span> TEST.z<span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For GAM model</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">xG_gam =</span> <span class="fu">predict</span>(m2_gam_TRAIN, <span class="at">newdata =</span> <span class="fu">cur_data</span>(),<span class="at">type=</span><span class="st">"response"</span>)<span class="sc">*</span><span class="dv">6</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">gam_Xp_err =</span> <span class="fu">round</span>(shots.result.points <span class="sc">-</span> xG_gam, <span class="dv">3</span>),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For Random Forest model</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">xG_rf =</span> <span class="fu">predict</span>(m4_rf_TRAIN, <span class="at">data =</span> <span class="fu">cur_data</span>(), <span class="at">type =</span> <span class="st">"response"</span>)<span class="sc">$</span>predictions[,<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">6</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">RF_Xp_err =</span> <span class="fu">round</span>(shots.result.points <span class="sc">-</span> xG_rf, <span class="dv">3</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>MAE_gam_test <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(TEST.z<span class="sc">$</span>gam_Xp_err)),<span class="dv">2</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>MAE_RF_test  <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(TEST.z<span class="sc">$</span>RF_Xp_err)),<span class="dv">2</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>g5<span class="ot">=</span> <span class="fu">ggplot</span>(TEST.z,<span class="fu">aes</span>(<span class="fu">abs</span>(Champ_Xp_err))) <span class="sc">+</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#009E73"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>               TEST.z, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(gam_Xp_err)))<span class="sc">+</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>       <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">"#E69F00"</span>,<span class="at">alpha=</span>.<span class="dv">3</span>,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>               TEST.z, <span class="at">mapping=</span><span class="fu">aes</span>(<span class="fu">abs</span>(RF_Xp_err)))<span class="sc">+</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">glue</span>(<span class="st">"&lt;b&gt;Test data&lt;/b&gt;&lt;br&gt;</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="st">                 &lt;span style='color:#009E73;'&gt;GAM: {MAE_gam_test}&lt;/span&gt;,</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="st">                 &lt;span style='color:#E69F00;'&gt;RF: {MAE_RF_test}&lt;/span&gt;"</span>))<span class="sc">+</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_markdown</span>(<span class="at">lineheight =</span> <span class="fl">1.1</span>),</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">11</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>g2<span class="sc">|</span>g5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="module4_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>What do you notice?</strong></p>
</section>
<section id="wrapping-up" class="level2" data-number="5.10">
<h2 data-number="5.10" class="anchored" data-anchor-id="wrapping-up"><span class="header-section-number">5.10</span> Wrapping up</h2>
<p>We have explored some commonly use machine learning algorithms today that can be used for both regression (predicting a number) and classification (predicting a class). There are many other algorithms that could be really useful and are discussed in some of the books I have referenced these include but not limited to.</p>
<ul>
<li><p>MARS : Multi-Adaptive Regression Splines</p></li>
<li><p>BART: Bayesian Additive Regression Trees</p></li>
<li><p>GPboost : allows for combining tree-boosting with Gaussian process and mixed effects models.</p></li>
<li><p>XGboost: Extreme Gradient Boosting</p></li>
</ul>
</section>
<section id="next-week" class="level2" data-number="5.11">
<h2 data-number="5.11" class="anchored" data-anchor-id="next-week"><span class="header-section-number">5.11</span> Next Week</h2>
<p>We will explore in more detail over model performance metrics, model tuning and techniques for assessing model validity,reliability and calibration.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./module3.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Module 3</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">references.html</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>